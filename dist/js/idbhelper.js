'use strict';

const port = 1337; // Change this to your server port

const OBJECTSTORE = 'restaurants';
const REVIEWOBJECTSTORE = 'reviews';
/**
 * IndexDB database helper functions.
 */

class IDBHelper {
  static openIDB() {
    if (!navigator.serviceWorker) {
      return Promise.resolve();
    }

    if (!self.indexedDB) reject("IndexedDB is NOT supported in this browser!"); // if( 'function' === typeof importScripts || (typeof idb === "undefined") ) {
    //       importScripts('js/idb.js');
    // }

    return idb.open('restaurants', 4, function (upgradeDb) {
      switch (upgradeDb.oldVersion) {
        case 0:
          upgradeDb.createObjectStore(OBJECTSTORE, {
            keyPath: 'id'
          });

        case 1:
          var restaurantStore = upgradeDb.transaction.objectStore(OBJECTSTORE);
          restaurantStore.createIndex('by-id', 'id');

        case 2:
          var reviewStore = upgradeDb.createObjectStore(REVIEWOBJECTSTORE, {
            keyPath: 'id'
          });
          reviewStore.createIndex('by-restaurant-id', 'restaurant_id');
          reviewStore.createIndex('by-review-id', 'id');
      }
    });
  }

  static insertIntoIndexDB(data) {
    console.log("idbhelper..insertIntoIDB..", data);
    IDBHelper.openIDB().then(function (db) {
      if (!db) return;
      var tx = db.transaction(OBJECTSTORE, 'readwrite');
      var store = tx.objectStore(OBJECTSTORE);
      data.forEach(restaurant => {
        store.put(restaurant);
      });
      return tx.complete;
    }); //return data;
  }

  static fetchFromAPIInsertIntoIDB(id) {
    let fetchURL;

    if (!id) {
      fetchURL = DBHelper.DATABASE_URL;
    } else {
      fetchURL = DBHelper.DATABASE_URL + '/' + id;
    }

    console.log("idbhelper.. fetchFromAPIInsertIntoIDB");
    return fetch(fetchURL).then(response => {
      return response.json();
    }).then(restaurants => {
      IDBHelper.insertIntoIndexDB(restaurants);
      return restaurants;
    });
  }

  static fetchFromIDB() {
    return IDBHelper.openIDB().then(db => {
      if (!db) return;
      var store = db.transaction(OBJECTSTORE).objectStore(OBJECTSTORE);
      console.log("fetchFromIDB", store.getAll());
      return store.getAll();
    });
  }

  static updateIsFavorite(restaurantId, newState) {
    fetch(`${DBHelper.DATABASE_URL}/${restaurantId}/?is_favorite=${newState}`, {
      method: 'PUT'
    }).then(() => {
      console.log(`Favorite status of restaurant ${restaurantId} is successfully changed to ${newState}`);
      return IDBHelper.openIDB().then(db => {
        if (!db) return;
        var tx = db.transaction(OBJECTSTORE, 'readwrite');
        var restaurantObjectStore = tx.objectStore(OBJECTSTORE);
        restaurantObjectStore.get(restaurantId).then(restaurant => {
          restaurant.is_favorite = newState;
          restaurantObjectStore.put(restaurant);
        });
      });
    }).catch(error => console.log('updateIsFavorite', error));
  }

  static fetchReviewsFromIDBByRestaurantId(restaurantId) {
    console.log("idbhelper..fetchReviewsFromIDBByRestaurantId", restaurantId);
    return IDBHelper.openIDB().then(db => {
      if (!db) return;
      var store = db.transaction(REVIEWOBJECTSTORE).objectStore(REVIEWOBJECTSTORE).index('by-review-id');
      console.log("fetchReviewsFromIDBByRestaurantId", store.getAll());
      return store.getAll();
    });
  }

  static insertReviewsIntoIndexDBByRestaurantId(data) {
    console.log("idbhelper..insertReviewsIntoIndexDBByRestaurantId.. 1", data);
    return IDBHelper.openIDB().then(function (db) {
      if (!db) return;
      var tx = db.transaction(REVIEWOBJECTSTORE, 'readwrite');
      var store = tx.objectStore(REVIEWOBJECTSTORE);
      data.forEach(review => {
        console.log("idbhelper..inserting reviews", review);
        store.put(review);
      });
      return tx.complete;
    });
  }

  static fetchReviewsFromAPIInsertIntoIDB(restaurantId) {
    console.log("idbhelper.. fetchReviewsFromAPIInsertIntoIDB..", DBHelper.DATABASE_REVIEW_URL);
    return fetch(`${DBHelper.DATABASE_REVIEW_URL}/?restaurant_id=${restaurantId}`).then(response => {
      return response.json();
    }).then(reviews => {
      IDBHelper.insertReviewsIntoIndexDBByRestaurantId(reviews);
      return reviews;
    });
  }

  static addNewReviewToIDB(restaurantId, reviewObj) {
    console.log("idbhelper..addNewReviewToIDB..", reviewObj);
    return IDBHelper.openIDB().then(function (db) {
      if (!db) return;
      var store = db.transaction(REVIEWOBJECTSTORE, 'readwrite').objectStore(REVIEWOBJECTSTORE); // var store = tx.objectStore(REVIEWOBJECTSTORE);           

      data.forEach(review => {
        console.log("idbhelper..inserting reviews", review);
        store.put(review);
      });
      return tx.complete;
    });
  }

  static addNewReview(restaurantId, reviewObj, callback) {
    //addNewReviewToIDB(restaurantId, reviewObj);
    const options = {
      method: 'POST',
      data: JSON.stringify(reviewObj) // ,headers: {
      //     "Content-Type": "application/json; charset=utf-8"
      // }

    };
    fetch(`${DBHelper.DATABASE_REVIEW_URL}`, {
      method: 'POST',
      body: JSON.stringify(reviewObj)
    }).then(response => response.json()).then(review => {
      console.log("Successfully added new review to database", review);
      callback(null, review);
    }).catch(error => {
      console.log('Unable to add new review to database', error);
      callback(error, null);
    });
  }

}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImlkYmhlbHBlci5qcyJdLCJuYW1lcyI6WyJwb3J0IiwiT0JKRUNUU1RPUkUiLCJSRVZJRVdPQkpFQ1RTVE9SRSIsIklEQkhlbHBlciIsIm9wZW5JREIiLCJuYXZpZ2F0b3IiLCJzZXJ2aWNlV29ya2VyIiwiUHJvbWlzZSIsInJlc29sdmUiLCJzZWxmIiwiaW5kZXhlZERCIiwicmVqZWN0IiwiaWRiIiwib3BlbiIsInVwZ3JhZGVEYiIsIm9sZFZlcnNpb24iLCJjcmVhdGVPYmplY3RTdG9yZSIsImtleVBhdGgiLCJyZXN0YXVyYW50U3RvcmUiLCJ0cmFuc2FjdGlvbiIsIm9iamVjdFN0b3JlIiwiY3JlYXRlSW5kZXgiLCJyZXZpZXdTdG9yZSIsImluc2VydEludG9JbmRleERCIiwiZGF0YSIsImNvbnNvbGUiLCJsb2ciLCJ0aGVuIiwiZGIiLCJ0eCIsInN0b3JlIiwiZm9yRWFjaCIsInJlc3RhdXJhbnQiLCJwdXQiLCJjb21wbGV0ZSIsImZldGNoRnJvbUFQSUluc2VydEludG9JREIiLCJpZCIsImZldGNoVVJMIiwiREJIZWxwZXIiLCJEQVRBQkFTRV9VUkwiLCJmZXRjaCIsInJlc3BvbnNlIiwianNvbiIsInJlc3RhdXJhbnRzIiwiZmV0Y2hGcm9tSURCIiwiZ2V0QWxsIiwidXBkYXRlSXNGYXZvcml0ZSIsInJlc3RhdXJhbnRJZCIsIm5ld1N0YXRlIiwibWV0aG9kIiwicmVzdGF1cmFudE9iamVjdFN0b3JlIiwiZ2V0IiwiaXNfZmF2b3JpdGUiLCJjYXRjaCIsImVycm9yIiwiZmV0Y2hSZXZpZXdzRnJvbUlEQkJ5UmVzdGF1cmFudElkIiwiaW5kZXgiLCJpbnNlcnRSZXZpZXdzSW50b0luZGV4REJCeVJlc3RhdXJhbnRJZCIsInJldmlldyIsImZldGNoUmV2aWV3c0Zyb21BUElJbnNlcnRJbnRvSURCIiwiREFUQUJBU0VfUkVWSUVXX1VSTCIsInJldmlld3MiLCJhZGROZXdSZXZpZXdUb0lEQiIsInJldmlld09iaiIsImFkZE5ld1JldmlldyIsImNhbGxi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b3VyY2VzQ29udGVudCI6WyIndXNlIHN0cmljdCc7XHJcblxyXG5jb25zdCBwb3J0ID0gMTMzNyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XHJcbmNvbnN0IE9CSkVDVFNUT1JFID0gJ3Jlc3RhdXJhbnRzJztcclxuY29uc3QgUkVWSUVXT0JKRUNUU1RPUkUgPSAncmV2aWV3cyc7XHJcblxyXG5cclxuLyoqXHJcbiAqIEluZGV4REIgZGF0YWJhc2UgaGVscGVyIGZ1bmN0aW9ucy5cclxuICovXHJcbmNsYXNzIElEQkhlbHBlciB7XHJcbiAgICBzdGF0aWMgb3BlbklEQigpIHtcclxuICAgICAgICBpZiAoIW5hdmlnYXRvci5zZXJ2aWNlV29ya2VyKSB7IHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsgfVxyXG4gICAgICAgIGlmICghc2VsZi5pbmRleGVkREIpIHJlamVjdChcIkluZGV4ZWREQiBpcyBOT1Qgc3VwcG9ydGVkIGluIHRoaXMgYnJvd3NlciFcIik7XHJcbiAgICAgICAgLy8gaWYoICdmdW5jdGlvbicgPT09IHR5cGVvZiBpbXBvcnRTY3JpcHRzIHx8ICh0eXBlb2YgaWRiID09PSBcInVuZGVmaW5lZFwiKSApIHtcclxuICAgICAgICAvLyAgICAgICBpbXBvcnRTY3JpcHRzKCdqcy9pZGIuanMnKTtcclxuICAgICAgICAvLyB9XHJcblxyXG4gICAgICAgIHJldHVybiBpZGIub3BlbigncmVzdGF1cmFudHMnLCA0LCBmdW5jdGlvbiAodXBncmFkZURiKSB7XHJcbiAgICAgICAgICAgIHN3aXRjaCAodXBncmFkZURiLm9sZFZlcnNpb24pIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgMDpcclxuICAgICAgICAgICAgICAgICAgICB1cGdyYWRlRGIuY3JlYXRlT2JqZWN0U3RvcmUoT0JKRUNUU1RPUkUsIHsga2V5UGF0aDogJ2lkJyB9KTtcclxuICAgICAgICAgICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgICAgICAgICAgICB2YXIgcmVzdGF1cmFudFN0b3JlID0gdXBncmFkZURiLnRyYW5zYWN0aW9uLm9iamVjdFN0b3JlKE9CSkVDVFNUT1JFKTtcclxuICAgICAgICAgICAgICAgICAgICByZXN0YXVyYW50U3RvcmUuY3JlYXRlSW5kZXgoJ2J5LWlkJywgJ2lkJyk7XHJcbiAgICAgICAgICAgICAgICBjYXNlIDI6XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJldmlld1N0b3JlID0gdXBncmFkZURiLmNyZWF0ZU9iamVjdFN0b3JlKFJFVklFV09CSkVDVFNUT1JFLCB7IGtleVBhdGg6ICdpZCcgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV2aWV3U3RvcmUuY3JlYXRlSW5kZXgoJ2J5LXJlc3RhdXJhbnQtaWQnLCAncmVzdGF1cmFudF9pZCcpO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldmlld1N0b3JlLmNyZWF0ZUluZGV4KCdieS1yZXZpZXctaWQnLCAnaWQnKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHN0YXRpYyBpbnNlcnRJbnRvSW5kZXhEQihkYXRhKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJpZGJoZWxwZXIuLmluc2VydEludG9JREIuLlwiLCBkYXRhKTtcclxuICAgICAgICBJREJIZWxwZXIub3BlbklEQigpLnRoZW4oZnVuY3Rpb24gKGRiKSB7XHJcbiAgICAgICAgICAgIGlmICghZGIpIHJldHVybjtcclxuXHJcbiAgICAgICAgICAgIHZhciB0eCA9IGRiLnRyYW5zYWN0aW9uKE9CSkVDVFNUT1JFLCAncmVhZHdyaXRlJyk7XHJcbiAgICAgICAgICAgIHZhciBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKE9CSkVDVFNUT1JFKTtcclxuICAgICAgICAgICAgZGF0YS5mb3JFYWNoKHJlc3RhdXJhbnQgPT4ge1xyXG4gICAgICAgICAgICAgICAgc3RvcmUucHV0KHJlc3RhdXJhbnQpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHR4LmNvbXBsZXRlOyAgICAgICAgICAgXHJcbiAgICAgICAgfSk7ICAgICAgICBcclxuICAgICAgICAvL3JldHVybiBkYXRhO1xyXG4gICAgfTtcclxuXHJcblxyXG4gICAgc3RhdGljIGZldGNoRnJvbUFQSUluc2VydEludG9JREIoaWQpIHtcclxuICAgICAgICBsZXQgZmV0Y2hVUkw7XHJcbiAgICAgICAgaWYgKCFpZCkge1xyXG4gICAgICAgICAgICBmZXRjaFVSTCA9IERCSGVscGVyLkRBVEFCQVNFX1VSTDtcclxuICAgICAgICB9ZWxzZXtcclxuICAgICAgICAgICAgZmV0Y2hVUkwgPSBEQkhlbHBlci5EQVRBQkFTRV9VUkwgKyAnLycgKyBpZDtcclxuICAgICAgICB9XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJpZGJoZWxwZXIuLiBmZXRjaEZyb21BUElJbnNlcnRJbnRvSURCXCIpO1xyXG4gICAgICAgIHJldHVybiAgZmV0Y2goZmV0Y2hVUkwpXHJcbiAgICAgICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKClcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLnRoZW4ocmVzdGF1cmFudHMgPT4ge1xyXG4gICAgICAgICAgICAgICAgSURCSGVscGVyLmluc2VydEludG9JbmRleERCKHJlc3RhdXJhbnRzKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiByZXN0YXVyYW50cztcclxuICAgICAgICAgICAgfSk7ICAgICAgICBcclxuICAgIH07XHJcblxyXG4gICAgc3RhdGljIGZldGNoRnJvbUlEQigpIHtcclxuICAgICAgICByZXR1cm4gSURCSGVscGVyLm9wZW5JREIoKS50aGVuKGRiID0+IHtcclxuICAgICAgICAgICAgaWYgKCFkYikgcmV0dXJuO1xyXG4gICAgICAgICAgICB2YXIgc3RvcmUgPSBkYi50cmFuc2FjdGlvbihPQkpFQ1RTVE9SRSkub2JqZWN0U3RvcmUoT0JKRUNUU1RPUkUpO1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcImZldGNoRnJvbUlEQlwiLCBzdG9yZS5nZXRBbGwoKSk7XHJcbiAgICAgICAgICAgIHJldHVybiBzdG9yZS5nZXRBbGwoKTtcclxuICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgc3RhdGljIHVwZGF0ZUlzRmF2b3JpdGUocmVzdGF1cmFudElkLCBuZXdTdGF0ZSl7XHJcbiAgICAgICAgZmV0Y2goYCR7REJIZWxwZXIuREFUQUJBU0VfVVJMfS8ke3Jlc3RhdXJhbnRJZH0vP2lzX2Zhdm9yaXRlPSR7bmV3U3RhdGV9YCwge1xyXG4gICAgICAgICAgICBtZXRob2Q6ICdQVVQnXHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgRmF2b3JpdGUgc3RhdHVzIG9mIHJlc3RhdXJhbnQgJHtyZXN0YXVyYW50SWR9IGlzIHN1Y2Nlc3NmdWxseSBjaGFuZ2VkIHRvICR7bmV3U3RhdGV9YCk7XHJcbiAgICAgICAgICAgIHJldHVybiBJREJIZWxwZXIub3BlbklEQigpLnRoZW4oZGIgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYoIWRiKSByZXR1cm47XHJcbiAgICAgICAgICAgICAgICB2YXIgdHggPSBkYi50cmFuc2FjdGlvbihPQkpFQ1RTVE9SRSwgJ3JlYWR3cml0ZScpO1xyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgICAgICAgICB2YXIgcmVzdGF1cmFudE9iamVjdFN0b3JlID0gdHgub2JqZWN0U3RvcmUoT0JKRUNUU1RPUkUpO1xyXG4gICAgICAgICAgICAgICAgcmVzdGF1cmFudE9iamVjdFN0b3JlLmdldChyZXN0YXVyYW50SWQpXHJcbiAgICAgICAgICAgICAgICAudGhlbihyZXN0YXVyYW50ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICByZXN0YXVyYW50LmlzX2Zhdm9yaXRlID0gbmV3U3RhdGU7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVzdGF1cmFudE9iamVjdFN0b3JlLnB1dChyZXN0YXVyYW50KTtcclxuICAgICAgICAgICAgICAgIH0pICAgICAgICAgICBcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgIH0pXHJcbiAgICAgICAgICAuY2F0Y2goZXJyb3IgPT4gY29uc29sZS5sb2coJ3VwZGF0ZUlzRmF2b3JpdGUnLCBlcnJvcikpOyAgICBcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgZmV0Y2hSZXZpZXdzRnJvbUlEQkJ5UmVzdGF1cmFudElkKHJlc3RhdXJhbnRJZCkge1xyXG4gICAgICAgIGNvbnNvbGUubG9nKFwiaWRiaGVscGVyLi5mZXRjaFJldmlld3NGcm9tSURCQnlSZXN0YXVyYW50SWRcIiwgcmVzdGF1cmFudElkKTtcclxuICAgICAgICByZXR1cm4gSURCSGVscGVyLm9wZW5JREIoKS50aGVuKGRiID0+IHtcclxuICAgICAgICAgICAgaWYgKCFkYikgcmV0dXJuO1xyXG4gICAgICAgICAgICB2YXIgc3RvcmUgPSBkYi50cmFuc2FjdGlvbihSRVZJRVdPQkpFQ1RTVE9SRSkub2JqZWN0U3RvcmUoUkVWSUVXT0JKRUNUU1RPUkUpLmluZGV4KCdieS1yZXZpZXctaWQnKTtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coXCJmZXRjaFJldmlld3NGcm9tSURCQnlSZXN0YXVyYW50SWRcIiwgc3RvcmUuZ2V0QWxsKCkpO1xyXG4gICAgICAgICAgICByZXR1cm4gc3RvcmUuZ2V0QWxsKCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIHN0YXRpYyBpbnNlcnRSZXZpZXdzSW50b0luZGV4REJCeVJlc3RhdXJhbnRJZChkYXRhKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJpZGJoZWxwZXIuLmluc2VydFJldmlld3NJbnRvSW5kZXhEQkJ5UmVzdGF1cmFudElkLi4gMVwiLCBkYXRhKTtcclxuICAgICAgICByZXR1cm4gSURCSGVscGVyLm9wZW5JREIoKS50aGVuKGZ1bmN0aW9uIChkYikge1xyXG4gICAgICAgICAgICBpZiAoIWRiKSByZXR1cm47XHJcblxyXG4gICAgICAgICAgICB2YXIgdHggPSBkYi50cmFuc2FjdGlvbihSRVZJRVdPQkpFQ1RTVE9SRSwgJ3JlYWR3cml0ZScpO1xyXG4gICAgICAgICAgICB2YXIgc3RvcmUgPSB0eC5vYmplY3RTdG9yZShSRVZJRVdPQkpFQ1RTVE9SRSk7ICAgICAgICAgICBcclxuICAgICAgICAgICAgZGF0YS5mb3JFYWNoKHJldmlldyA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcImlkYmhlbHBlci4uaW5zZXJ0aW5nIHJldmlld3NcIiwgcmV2aWV3KTtcclxuICAgICAgICAgICAgICAgIHN0b3JlLnB1dChyZXZpZXcpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIHR4LmNvbXBsZXRlO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfTtcclxuXHJcbiAgICBzdGF0aWMgZmV0Y2hSZXZpZXdzRnJvbUFQSUluc2VydEludG9JREIocmVzdGF1cmFudElkKSB7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJpZGJoZWxwZXIuLiBmZXRjaFJldmlld3NGcm9tQVBJSW5zZXJ0SW50b0lEQi4uXCIsIERCSGVscGVyLkRBVEFCQVNFX1JFVklFV19VUkwpO1xyXG4gICAgICAgIHJldHVybiBmZXRjaChgJHtEQkhlbHBlci5EQVRBQkFTRV9SRVZJRVdfVVJMfS8/cmVzdGF1cmFudF9pZD0ke3Jlc3RhdXJhbnRJZH1gKVxyXG4gICAgICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UuanNvbigpXHJcbiAgICAgICAgICAgIH0pLnRoZW4ocmV2aWV3cyA9PiB7XHJcbiAgICAgICAgICAgICAgICBJREJIZWxwZXIuaW5zZXJ0UmV2aWV3c0ludG9JbmRleERCQnlSZXN0YXVyYW50SWQocmV2aWV3cyk7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gcmV2aWV3cztcclxuICAgICAgICAgICAgfSk7XHJcbiAgICB9O1xyXG5cclxuICAgIHN0YXRpYyBhZGROZXdSZXZpZXdUb0lEQihyZXN0YXVyYW50SWQsIHJldmlld09iail7XHJcbiAgICAgICAgY29uc29sZS5sb2coXCJpZGJoZWxwZXIuLmFkZE5ld1Jldmlld1RvSURCLi5cIiwgcmV2aWV3T2JqKTtcclxuICAgICAgICByZXR1cm4gSURCSGVscGVyLm9wZW5JREIoKS50aGVuKGZ1bmN0aW9uIChkYikge1xyXG4gICAgICAgICAgICBpZiAoIWRiKSByZXR1cm47XHJcblxyXG4gICAgICAgICAgICB2YXIgc3RvcmUgPSBkYi50cmFuc2FjdGlvbihSRVZJRVdPQkpFQ1RTVE9SRSwgJ3JlYWR3cml0ZScpLm9iamVjdFN0b3JlKFJFVklFV09CSkVDVFNUT1JFKTsgXHJcbiAgICAgICAgICAgLy8gdmFyIHN0b3JlID0gdHgub2JqZWN0U3RvcmUoUkVWSUVXT0JKRUNUU1RPUkUpOyAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGRhdGEuZm9yRWFjaChyZXZpZXcgPT4ge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJpZGJoZWxwZXIuLmluc2VydGluZyByZXZpZXdzXCIsIHJldmlldyk7XHJcbiAgICAgICAgICAgICAgICBzdG9yZS5wdXQocmV2aWV3KTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiB0eC5jb21wbGV0ZTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBzdGF0aWMgYWRkTmV3UmV2aWV3KHJlc3RhdXJhbnRJZCwgcmV2aWV3T2JqLCBjYWxsYmFjayl7XHJcbiAgICAgICAgLy9hZGROZXdSZXZpZXdUb0lEQihyZXN0YXVyYW50SWQsIHJldmlld09iaik7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgIGRhdGE6IEpTT04uc3RyaW5naWZ5KHJldmlld09iailcclxuICAgICAgICAgICAgLy8gLGhlYWRlcnM6IHtcclxuICAgICAgICAgICAgLy8gICAgIFwiQ29udGVudC1UeXBlXCI6IFwiYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOFwiXHJcbiAgICAgICAgICAgIC8vIH1cclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICBmZXRjaChgJHtEQkhlbHBlci5EQVRBQkFTRV9SRVZJRVdfVVJMfWAsIHtcclxuICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsXHJcbiAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJldmlld09iailcclxuICAgICAgICB9KVxyXG4gICAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLmpzb24oKSlcclxuICAgICAgICAudGhlbihyZXZpZXcgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIlN1Y2Nlc3NmdWxseSBhZGRlZCBuZXcgcmV2aWV3IHRvIGRhdGFiYXNlXCIsIHJldmlldyk7XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIHJldmlldyk7XHJcbiAgICAgICAgfSlcclxuICAgICAgICAuY2F0Y2goZXJyb3IgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnVW5hYmxlIHRvIGFkZCBuZXcgcmV2aWV3IHRvIGRhdGFiYXNlJywgZXJyb3IpO1xyXG4gICAgICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG59Il0sImZpbGUiOiJpZGJoZWxwZXIuanMifQ==
